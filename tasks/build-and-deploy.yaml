---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-app
spec:
  params:
    - name: contextDir
      description: the context dir within source
      default: .
    - name: destinationImage
      description: the fully qualified image name
      default: "$(outputs.resources.hello-image.url)"
    - name: dockerFile
      description: the docker file to used for building the application
      default: Dockerfile
    # - name: tlsVerify
    #   description: tls verify
    #   type: string
    #   default: "false"
  resources:
    inputs:
      - name: repo
        type: git
    outputs:
      - name: hello-image
        type: image
  steps:
    - name: install-dependencies
      image: docker.io/golang:1.15
      workingDir: "/workspace/repo/$(inputs.params.contextDir)"
      command:
        - go
      args:
        - mod
        - download
    - name: run-unit-tests
      image: docker.io/golang:1.15
      workingDir: "/workspace/repo/$(inputs.params.contextDir)"
      command:
        - go
      args:
        - test
    - name: build-image
      image: quay.io/buildah/stable
      workingDir: "/workspace/repo/$(inputs.params.contextDir)"
      command:
        - buildah
      args:
        - bud
        - --layers
        - -f
        - $(inputs.params.dockerFile)
        - -t
        - $(inputs.params.destinationImage)
        - .
      securityContext:
        privileged: true
        runAsUser: 0
      volumeMounts:
        - name: varlibc
          mountPath: /var/lib/containers
    # - name: push-image
    #   image: quay.io/buildah/stable
    #   workingDir: "/workspace/source/$(inputs.params.contextDir)"
    #   command:
    #     - "buildah"
    #   args:
    #     - "push"
    #     - "--tls-verify=$(inputs.params.tlsVerify)"
    #     - $(inputs.params.destinationImage)
    #     - "docker://$(inputs.params.destinationImage)"
    #   securityContext:
    #     runAsUser: 0
    #     privileged: true
    #   volumeMounts:
    #     - name: varlibc
    #       mountPath: /var/lib/containers
  volumes:
    - name: varlibc
      emptyDir: {}